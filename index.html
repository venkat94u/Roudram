<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Institutional Execution Cluster Engine</title>

<style>
body{
  background:#071226;
  color:#e6f0fb;
  font-family:Inter,system-ui,Arial;
  margin:0;
}
.wrap{max-width:1100px;margin:12px auto;padding:12px}
.card{
  background:#0f2030;
  border:1px solid #152433;
  border-radius:12px;
  padding:12px;
  margin-bottom:12px;
}
h2{margin:0 0 8px 0;font-size:16px}
.small{font-size:12px;color:#9fb0c8}
.level{font-size:13px;margin-bottom:4px}
.above{color:#ff8a8a}
.below{color:#7dffb3}
.price{font-weight:600}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
</style>
</head>

<body>
<div class="wrap">

  <div class="card">
    <h2>Current Price</h2>
    <div id="price" style="font-size:22px;font-weight:600">—</div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>Execution Clusters ABOVE</h2>
      <div class="small">Where most contracts exchanged hands (above)</div>
      <div id="clustersAbove" style="margin-top:8px">—</div>
    </div>

    <div class="card">
      <h2>Execution Clusters BELOW</h2>
      <div class="small">Where most contracts exchanged hands (below)</div>
      <div id="clustersBelow" style="margin-top:8px">—</div>
    </div>
  </div>

</div>

<script>
/* =========================
   CONFIG (INSTITUTIONAL)
   ========================= */
const SYMBOL = "btcusdt";
const TICK_SIZE = 1;            // BTC: 1, ETH: 0.1
const MIN_CLUSTER_VOL = 30;     // ignore noise
const FREEZE_MS = 60_000;       // freeze clusters every 1 minute
const MAX_LEVELS_EACH_SIDE = 20;

/* =========================
   STATE
   ========================= */
let execMap = new Map();        // price -> executed volume
let frozenClusters = [];       // [{price, vol}]
let lastFreezeTs = 0;
let lastPrice = null;

/* =========================
   HELPERS
   ========================= */
function bucketPrice(p){
  return Math.round(p / TICK_SIZE) * TICK_SIZE;
}

function freezeClusters(){
  const now = Date.now();
  if(now - lastFreezeTs < FREEZE_MS) return;
  lastFreezeTs = now;

  frozenClusters = [...execMap.entries()]
    .filter(([_,v]) => v >= MIN_CLUSTER_VOL)
    .sort((a,b)=>b[1]-a[1])
    .map(([p,v]) => ({price:p, vol:v}));
}

function splitClusters(){
  if(!lastPrice) return {above:[], below:[]};

  const above = frozenClusters
    .filter(c=>c.price > lastPrice)
    .sort((a,b)=>a.price-b.price)
    .slice(0, MAX_LEVELS_EACH_SIDE);

  const below = frozenClusters
    .filter(c=>c.price < lastPrice)
    .sort((a,b)=>b.price-a.price)
    .slice(0, MAX_LEVELS_EACH_SIDE);

  return {above, below};
}

/* =========================
   UI
   ========================= */
const priceEl = document.getElementById("price");
const aboveEl = document.getElementById("clustersAbove");
const belowEl = document.getElementById("clustersBelow");

function render(){
  if(lastPrice) priceEl.innerText = lastPrice.toFixed(2);

  freezeClusters();
  const {above, below} = splitClusters();

  aboveEl.innerHTML = above.length
    ? above.map(c =>
        `<div class="level above">
          <span class="price">${c.price}</span> → ${c.vol.toFixed(2)}
        </div>`
      ).join("")
    : "—";

  belowEl.innerHTML = below.length
    ? below.map(c =>
        `<div class="level below">
          <span class="price">${c.price}</span> → ${c.vol.toFixed(2)}
        </div>`
      ).join("")
    : "—";
}

/* =========================
   TRADE HANDLER
   ========================= */
function onTrade(price, qty){
  lastPrice = price;

  const b = bucketPrice(price);
  execMap.set(b, (execMap.get(b)||0) + qty);

  render();
}

/* =========================
   BINANCE WS (TRADES)
   ========================= */
const ws = new WebSocket(
  `wss://fstream.binance.com/ws/${SYMBOL}@trade`
);

ws.onmessage = e => {
  const t = JSON.parse(e.data);
  const price = parseFloat(t.p);
  const qty = parseFloat(t.q);
  onTrade(price, qty);
};

ws.onopen = ()=>console.log("Connected");
ws.onerror = e=>console.error(e);
ws.onclose = ()=>console.log("Disconnected");
</script>
</body>
</html>
